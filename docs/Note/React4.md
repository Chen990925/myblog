---
group: React
title: Fiber的理解
order: 4
---

## fiber 的理解

fiber 是链表数据结构，是为了可中断渲染而创建。

可以将 fiber tree 的一个个节点看作碎片化任务，优先处理浏览器的任务（例如事件处理、js 执行、布局/绘制）。

首先 react 会向浏览器请求调度：你那还有任务要完成吗？

回答有：就优先让浏览器完成它的任务，react 就边等边隔一段时间问相同的问题。

回答没有：react 就会把控制权拿来来完成自己的碎片任务（单一的碎片任务是不可中断的），每做完一个任务 react 都会问浏览器上面的问题。

这样就可以达到可中断的效果。

fiber 的执行流程：

render 阶段和 commit 阶段

- render 阶段：

  - 此阶段的主要任务就是找出所有节点的变更，如节点新增、删除、属性变更等，这些变更， React 统称为副作用，此阶段会构建一棵 Fiber tree，以虚拟 dom 节点为维度对任务进行拆分，即一个虚拟 Dom 节点对应一个任务，最后产出的结果是 effect list，从中统计出知道哪些节点需要更新、哪些节点需要增加、哪些节点需要删除。
  - 遍历 fiber 树的规则是：子 ——> 兄 ——> 叔

- commit 阶段：commit 阶段需要将上阶段计算出来的需要处理的副作用一次性执行，此阶段不能暂停，否则会出现 UI 更新不连续的现象。此阶段需要根据 effect list，将所有更新都 commit 到 DOM 树上。
